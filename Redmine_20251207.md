# Otium アプリケーション 設計書

**作成日**: 2025年12月7日  
**プロジェクト名**: Otium（オーティアム）  
**種別**: 記録管理モバイルアプリケーション

---

## 1. システム概要

### 1.1 アプリケーション概要
Otiumは、ユーザーが日々の記録を作成・管理できるモバイルアプリケーションです。JWT認証により、各ユーザーは自分の記録のみにアクセスでき、セキュアな環境で記録を管理できます。

### 1.2 主要機能
- ユーザー登録・ログイン（JWT認証）
- 記録の作成・閲覧・更新・削除（CRUD操作）
- ユーザーごとのデータ分離
- セキュアなトークン管理

---

## 2. システムアーキテクチャ

### 2.1 全体構成
```
┌─────────────────────────────────────┐
│      クライアント層                  │
│   React Native (Expo)               │
│   - iOS/Android アプリ              │
│   - JWT トークン管理                │
└──────────────┬──────────────────────┘
               │ HTTP/REST API
               │ (JSON)
┌──────────────▼──────────────────────┐
│      アプリケーション層              │
│   Node.js + Express                 │
│   - REST API エンドポイント         │
│   - JWT 認証ミドルウェア            │
│   - ビジネスロジック                │
└──────────────┬──────────────────────┘
               │ MySQL Driver
               │ (mysql2/promise)
┌──────────────▼──────────────────────┐
│      データ層                        │
│   MySQL データベース                │
│   - users テーブル                  │
│   - records テーブル                │
└─────────────────────────────────────┘
```

### 2.2 技術スタック

#### クライアント側（client-app）
| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| フレームワーク | React Native | 0.81.5 | モバイルアプリ開発 |
| プラットフォーム | Expo | ~54.0.25 | 開発環境・ビルド |
| UI フレームワーク | React | 19.1.0 | UI コンポーネント |
| ナビゲーション | React Navigation | ^7.1.24 | 画面遷移管理 |
| セキュアストレージ | expo-secure-store | ~15.0.8 | トークン保存 |
| 状態管理 | React Context API | - | 認証状態管理 |

#### サーバー側（server-api）
| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| ランタイム | Node.js | - | サーバー実行環境 |
| フレームワーク | Express | ^5.1.0 | REST API フレームワーク |
| データベース | MySQL | - | データ永続化 |
| DB ドライバー | mysql2 | ^3.15.3 | MySQL 接続 |
| 認証 | jsonwebtoken | ^9.0.2 | JWT トークン生成・検証 |
| パスワード暗号化 | bcrypt | ^6.0.0 | パスワードハッシュ化 |
| CORS | cors | ^2.8.5 | クロスオリジン対応 |
| 環境変数 | dotenv | ^17.2.3 | 環境変数管理 |

---

## 3. データベース設計

### 3.1 ER図
```
┌─────────────────────────────────────┐
│           users                     │
├─────────────────────────────────────┤
│ * id (PK)                           │
│   email (UNIQUE)                    │
│   user_name                         │
│   password_hash                     │
│   created_at                        │
│   updated_at                        │
└──────────────┬──────────────────────┘
               │ 1
               │
               │ N
┌──────────────▼──────────────────────┐
│           records                   │
├─────────────────────────────────────┤
│ * id (PK)                           │
│   user_id (FK)                      │
│   title                             │
│   description                       │
│   date_logged                       │
│   invalidation_flag                 │
│   created_at                        │
│   updated_at                        │
│   delete_at                         │
└─────────────────────────────────────┘
```

### 3.2 テーブル定義

#### users テーブル
ユーザーアカウント情報を管理するテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | ユーザーID（主キー） |
| email | VARCHAR | UNIQUE, NOT NULL | メールアドレス（ログインID） |
| user_name | VARCHAR | NULL | ユーザー表示名 |
| password_hash | VARCHAR | NOT NULL | bcrypt でハッシュ化されたパスワード |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- PRIMARY KEY: `id`
- UNIQUE INDEX: `email`

#### records テーブル
ユーザーの記録データを管理するテーブル

| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 記録ID（主キー） |
| user_id | INT | FOREIGN KEY, NOT NULL | ユーザーID（外部キー） |
| title | VARCHAR | NOT NULL | 記録のタイトル |
| description | TEXT | NULL | 記録の詳細説明 |
| date_logged | DATE | NOT NULL | 記録日付 |
| invalidation_flag | TINYINT | DEFAULT 0 | 削除フラグ（0: 有効, 1: 削除済み） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |
| delete_at | TIMESTAMP | NULL | 削除日時 |

**インデックス**:
- PRIMARY KEY: `id`
- FOREIGN KEY: `user_id` REFERENCES `users(id)`
- INDEX: `user_id, invalidation_flag`（検索性能向上のため）

---

## 4. API 仕様

### 4.1 ベース URL
```
http://<server-host>:3000/api
```

### 4.2 認証 API（/api/auth）

#### 4.2.1 ユーザー登録
**エンドポイント**: `POST /api/auth/signup`  
**認証**: 不要

**リクエストボディ**:
```json
{
  "email": "user@example.com",
  "user_name": "山田太郎",
  "password": "securePassword123"
}
```

**レスポンス（成功: 201）**:
```json
{
  "message": "ユーザー登録が完了しました。",
  "userId": 1
}
```

**エラーレスポンス**:
- `400`: メールアドレスまたはパスワードが未入力
- `409`: メールアドレスが既に登録済み
- `500`: サーバーエラー

---

#### 4.2.2 ログイン
**エンドポイント**: `POST /api/auth/login`  
**認証**: 不要

**リクエストボディ**:
```json
{
  "email": "user@example.com",
  "password": "securePassword123"
}
```

**レスポンス（成功: 200）**:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": 1,
    "user_name": "山田太郎"
  }
}
```

**エラーレスポンス**:
- `401`: メールアドレスまたはパスワードが正しくない
- `500`: サーバーエラー

---

### 4.3 記録 API（/api/records）
**すべてのエンドポイントで JWT 認証が必要**

**認証ヘッダー**:
```
Authorization: Bearer <JWT_TOKEN>
```

#### 4.3.1 記録の作成
**エンドポイント**: `POST /api/records`  
**認証**: 必要

**リクエストボディ**:
```json
{
  "title": "今日の振り返り",
  "description": "良い一日だった",
  "date_logged": "2025-12-07"
}
```

**レスポンス（成功: 201）**:
```json
{
  "message": "記録が作成されました。",
  "recordId": 10
}
```

**エラーレスポンス**:
- `400`: タイトルまたは日付が未入力
- `401`: 認証トークンが無効
- `500`: サーバーエラー

---

#### 4.3.2 記録の一覧取得
**エンドポイント**: `GET /api/records`  
**認証**: 必要

**レスポンス（成功: 200）**:
```json
[
  {
    "id": 10,
    "title": "今日の振り返り",
    "description": "良い一日だった",
    "created_at": "2025-12-07T10:30:00.000Z"
  },
  {
    "id": 9,
    "title": "昨日の記録",
    "description": "忙しかった",
    "created_at": "2025-12-06T15:20:00.000Z"
  }
]
```

**注意**: ログイン中のユーザーの記録のみが返されます（user_id でフィルタリング）

---

#### 4.3.3 記録の更新
**エンドポイント**: `PUT /api/records/:id`  
**認証**: 必要

**リクエストボディ**:
```json
{
  "title": "更新されたタイトル",
  "description": "更新された内容"
}
```

**レスポンス（成功: 200）**:
```json
{
  "message": "記録が更新されました。"
}
```

**エラーレスポンス**:
- `400`: タイトルまたは日付が未入力
- `401`: 認証トークンが無効
- `404`: 記録が見つからない、または更新権限がない
- `500`: サーバーエラー

**注意**: 現在のコードに構文エラーがあります（70行目: `date_logged` が未定義、76行目: SQLの構文エラー）

---

#### 4.3.4 記録の削除（論理削除）
**エンドポイント**: `DELETE /api/records/:id`  
**認証**: 必要

**レスポンス（成功: 200）**:
```json
{
  "message": "記録が削除されました。"
}
```

**エラーレスポンス**:
- `401`: 認証トークンが無効
- `404`: 記録が見つからない、または削除権限がない
- `500`: サーバーエラー

**注意**: 物理削除ではなく、`invalidation_flag=1` に設定し、`delete_at` に現在時刻を記録する論理削除

---

## 5. 認証フロー

### 5.1 JWT 認証の仕組み

```
┌──────────┐                    ┌──────────┐                    ┌──────────┐
│ Client   │                    │  Server  │                    │    DB    │
└────┬─────┘                    └────┬─────┘                    └────┬─────┘
     │                               │                               │
     │ 1. POST /api/auth/login       │                               │
     ├──────────────────────────────>│                               │
     │    { email, password }        │                               │
     │                               │ 2. SELECT user WHERE email=?  │
     │                               ├──────────────────────────────>│
     │                               │                               │
     │                               │ 3. user data                  │
     │                               │<──────────────────────────────┤
     │                               │                               │
     │                               │ 4. bcrypt.compare(password)   │
     │                               │                               │
     │                               │ 5. jwt.sign({ id, email })    │
     │                               │                               │
     │ 6. { token, user }            │                               │
     │<──────────────────────────────┤                               │
     │                               │                               │
     │ 7. Store token in SecureStore │                               │
     │                               │                               │
     │                               │                               │
     │ 8. GET /api/records           │                               │
     │    Authorization: Bearer XXX  │                               │
     ├──────────────────────────────>│                               │
     │                               │ 9. jwt.verify(token)          │
     │                               │                               │
     │                               │ 10. SELECT records WHERE ...  │
     │                               ├──────────────────────────────>│
     │                               │                               │
     │                               │ 11. records data              │
     │                               │<──────────────────────────────┤
     │                               │                               │
     │ 12. [records]                 │                               │
     │<──────────────────────────────┤                               │
     │                               │                               │
```

### 5.2 認証の流れ

#### ログイン時
1. クライアントがメールアドレスとパスワードを送信
2. サーバーがデータベースからユーザー情報を取得
3. bcrypt でパスワードを検証
4. 検証成功時、JWT トークンを生成（有効期限: 1日）
5. トークンとユーザー情報をクライアントに返す
6. クライアントが Expo SecureStore にトークンを保存

#### API リクエスト時
1. クライアントがリクエストヘッダーに `Authorization: Bearer <token>` を付与
2. サーバーの認証ミドルウェア（`middleware/auth.js`）がトークンを検証
3. 検証成功時、デコードされたユーザー情報を `req.user` に設定
4. API ハンドラーで `req.user.id` を使用してユーザー固有の処理を実行

#### ログアウト時
1. クライアントが SecureStore からトークンを削除
2. 認証状態をリセット

### 5.3 セキュリティ対策

| 対策 | 実装方法 |
|-----|---------|
| パスワードの暗号化 | bcrypt を使用（ソルトラウンド: 10） |
| トークンの署名 | JWT_SECRET 環境変数を使用した HMAC-SHA256 |
| トークンの有効期限 | 1日間（`expiresIn: '1d'`） |
| トークンの安全な保存 | Expo SecureStore（暗号化ストレージ） |
| API ルートの保護 | 認証ミドルウェアによる検証 |
| ユーザーデータの分離 | SQL クエリで user_id による絞り込み |

---

## 6. 画面構成と遷移

### 6.1 画面一覧

#### 未認証時の画面（AuthStack）
1. **LoginScreen** - ログイン画面
   - メールアドレスとパスワードの入力
   - ログインボタン
   - サインアップ画面へのリンク

2. **SignupScreen** - 新規登録画面
   - メールアドレス、ユーザー名、パスワードの入力
   - 登録ボタン
   - ログイン画面へのリンク

#### 認証済み時の画面（AppStack）
3. **RecordListScreen** - 記録一覧画面
   - 自分の記録の一覧表示
   - ヘッダー右に「追加」ボタン
   - 各記録の削除機能

4. **CreateRecordScreen** - 記録作成画面
   - タイトル入力
   - 説明入力
   - 日付選択
   - 作成ボタン

### 6.2 画面遷移図

```
┌─────────────────────────────────────────────────────┐
│             アプリ起動                               │
└────────────────┬────────────────────────────────────┘
                 │
                 │ AuthContext が
                 │ SecureStore から
                 │ トークンを確認
                 │
        ┌────────▼────────┐
        │ トークンあり？   │
        └────┬───────┬─────┘
             │       │
        No   │       │  Yes
             │       │
    ┌────────▼──┐  ┌▼──────────────┐
    │ AuthStack │  │   AppStack     │
    └────┬──────┘  └┬───────────────┘
         │          │
         │          │
┌────────▼──────┐  ┌▼────────────────────┐
│ LoginScreen   │  │ RecordListScreen    │
│               │  │                     │
│ ┌───────────┐ │  │ ┌─────────────────┐ │
│ │ Sign Up   │ │  │ │  [+] 追加       │ │
│ └─────┬─────┘ │  │ └────────┬────────┘ │
└───────┼───────┘  └───────────┼──────────┘
        │                      │
        │                      │
┌───────▼───────┐  ┌───────────▼──────────┐
│ SignupScreen  │  │ CreateRecordScreen   │
│               │  │                      │
│ ┌───────────┐ │  │ ┌────────────────┐  │
│ │ Login     │ │  │ │ 作成           │  │
│ └─────┬─────┘ │  │ └────────┬───────┘  │
└───────┼───────┘  └───────────┼──────────┘
        │                      │
        │ サインアップ成功       │ 記録作成成功
        │ →自動ログイン          │
        │                      │
        └──────────────┬───────┘
                       │
              ┌────────▼────────┐
              │ RecordListScreen│
              └─────────────────┘
```

### 6.3 ナビゲーション構造

```javascript
// AppNavigator.js の構造

<NavigationContainer>
  <Stack.Navigator>
    {userToken ? (
      // 認証済み: AppStack
      <Stack.Screen name="App">
        <Stack.Navigator>
          <Stack.Screen name="Records" component={RecordListScreen} />
          <Stack.Screen name="CreateRecord" component={CreateRecordScreen} />
        </Stack.Navigator>
      </Stack.Screen>
    ) : (
      // 未認証: AuthStack
      <Stack.Screen name="Auth">
        <Stack.Navigator>
          <Stack.Screen name="Login" component={LoginScreen} />
          <Stack.Screen name="Signup" component={SignupScreen} />
        </Stack.Navigator>
      </Stack.Screen>
    )}
  </Stack.Navigator>
</NavigationContainer>
```

---

## 7. ディレクトリ構成

### 7.1 クライアント（client-app/）

```
client-app/
├── api/                      # API 通信関連
│   ├── auth.js              # 認証API（signup, login）
│   ├── client.js            # 共通APIクライアント（useApiClient フック）
│   └── records.js           # 記録API（useRecordsApi フック）
│
├── context/                  # React Context
│   └── AuthContext.js       # 認証状態管理（トークン、ユーザー情報）
│
├── navigation/               # ナビゲーション
│   └── AppNavigator.js      # メインナビゲーター（AuthStack/AppStack切替）
│
├── screens/                  # 画面コンポーネント
│   ├── LoginScreen.js       # ログイン画面
│   ├── SignupScreen.js      # サインアップ画面
│   ├── RecordListScreen.js  # 記録一覧画面
│   └── CreateRecordScreen.js # 記録作成画面
│
├── assets/                   # 画像・アイコン
│   ├── icon.png
│   ├── splash-icon.png
│   └── ...
│
├── App.js                    # アプリケーションのエントリーポイント
├── index.js                  # Expo エントリーポイント
├── app.json                  # Expo 設定
├── package.json              # 依存関係
└── package-lock.json
```

### 7.2 サーバー（server-api/）

```
server-api/
├── middleware/               # ミドルウェア
│   └── auth.js              # JWT 認証ミドルウェア
│
├── authRoutes.js            # 認証関連のルート定義
├── recordsRoutes.js         # 記録関連のルート定義
├── db.js                    # MySQL 接続プール
├── server.js                # Express サーバーのエントリーポイント
├── package.json             # 依存関係
├── package-lock.json
└── .env                     # 環境変数（DB接続情報、JWT_SECRET）
```

### 7.3 データベース定義（Doc/DDL/）

```
Doc/
└── DDL/
    └── otium.a5er           # A5:SQL Mk-2 データベース設計ファイル
```

---

## 8. 主要な実装パターン

### 8.1 Context API による状態管理

**ファイル**: `client-app/context/AuthContext.js`

**役割**:
- ユーザーの認証状態（トークン、ユーザー情報）をアプリ全体で共有
- ログイン・サインアップ・ログアウト機能を提供

**主要な状態**:
- `isLoading`: 起動時のトークン読み込み中フラグ
- `userToken`: JWT トークン
- `userInfo`: ユーザー情報（ID、名前）

**提供する機能**:
- `signIn(email, password)`: ログイン
- `signUp(email, user_name, password)`: サインアップ
- `signOut()`: ログアウト

---

### 8.2 カスタムフックによる API 呼び出し

#### useApiClient フック
**ファイル**: `client-app/api/client.js`

**役割**:
- 共通の fetch ラッパーを提供
- 自動的に Authorization ヘッダーを付与
- エラーハンドリングの統一

**使用例**:
```javascript
const { apiFetch } = useApiClient();
const data = await apiFetch('/records', {
  method: 'POST',
  body: { title: 'Test', date_logged: '2025-12-07' }
});
```

#### useRecordsApi フック
**ファイル**: `client-app/api/records.js`

**役割**:
- 記録関連の API 呼び出しをラップ
- `createRecord()`, `fetchRecords()`, `deleteRecord()` を提供

---

### 8.3 認証ミドルウェアパターン

**ファイル**: `server-api/middleware/auth.js`

**役割**:
- すべての保護されたルートで JWT トークンを検証
- 検証成功時、`req.user` にユーザー情報を設定
- 検証失敗時、401 エラーを返す

**使用方法**:
```javascript
const auth = require('./middleware/auth');

// すべてのルートで認証を要求
router.use(auth);

// または個別のルートで適用
router.get('/records', auth, async (req, res) => {
  const user_id = req.user.id; // ミドルウェアで設定された値
  // ...
});
```

---

### 8.4 React Navigation による画面遷移

**ファイル**: `client-app/navigation/AppNavigator.js`

**パターン**:
- 認証状態に基づいて、AuthStack と AppStack を切り替え
- トークンの有無で自動的に画面が切り替わる
- ローディング中は専用のローディング画面を表示

---

## 9. 環境変数

### 9.1 サーバー側（.env）

```env
# データベース接続情報
DB_HOST=localhost
DB_USER=root
DB_PASSWORD=your_password
DB_DATABASE=otium

# JWT シークレットキー（ランダムな文字列を設定）
JWT_SECRET=your_super_secret_key_here

# サーバーポート（オプション）
PORT=3000
```

### 9.2 クライアント側

**ファイル**: `client-app/api/auth.js`, `client-app/api/client.js`

```javascript
const API_BASE_URL = 'http://192.168.1.148:3000/api';
```

**注意**: 本番環境では、環境変数または設定ファイルで管理すべき

---

## 10. 既知の問題と改善点

### 10.1 バグ

#### recordsRoutes.js の問題
**ファイル**: `server-api/recordsRoutes.js`

1. **70行目**: `date_logged` 変数が未定義
   - PUT エンドポイントで `date_logged` を使用しているが、`req.body` から取得していない

2. **76行目**: SQL 構文エラー
   - `SET title=?, description=?, WHERE ...` → カンマが余分
   - 正: `SET title=?, description=? WHERE ...`

**修正案**:
```javascript
router.put('/:id', async (req, res) => {
    const { id } = req.params;
    const { title, description, date_logged } = req.body; // date_logged を追加
    const user_id = req.user.id;

    if (!title || !date_logged) {
        return res.status(400).json({ message: 'タイトルと日付は必須です。' });
    }

    try {
        const [result] = await db.query(
            'UPDATE records SET title=?, description=?, date_logged=? WHERE id=? AND user_id=?', // カンマ修正、date_logged追加
            [title, description, date_logged, id, user_id]
        );
        // ...
    }
    // ...
});
```

### 10.2 改善提案

#### セキュリティ
1. **HTTPS の使用**: 本番環境では必須
2. **レート制限**: ログインエンドポイントにブルートフォース攻撃対策
3. **入力バリデーション**: より厳密な入力チェック（メールフォーマット、パスワード強度）
4. **CSRF 対策**: 必要に応じて実装

#### 機能
1. **パスワードリセット**: メール経由のパスワード再設定
2. **トークンリフレッシュ**: アクセストークンとリフレッシュトークンの分離
3. **記録の編集画面**: 現在は API のみ実装、UI が未実装
4. **記録の検索・フィルタリング**: 日付範囲、キーワード検索
5. **ページネーション**: 記録が多い場合の対応

#### コード品質
1. **エラーハンドリングの統一**: カスタムエラークラスの導入
2. **バリデーションライブラリ**: Joi や Yup の導入
3. **テストコード**: Jest などでユニット・統合テスト
4. **ロギング**: Winston などのロギングライブラリ
5. **環境変数の管理**: クライアント側も .env で管理

#### インフラ
1. **Docker化**: 開発環境の統一
2. **CI/CD**: 自動テスト・デプロイ
3. **データベースマイグレーション**: Sequelize や Knex.js の導入

---

## 11. デプロイメント

### 11.1 開発環境でのセットアップ

#### サーバー側
```bash
cd server-api
npm install
# .env ファイルを作成して環境変数を設定
node server.js
```

#### クライアント側
```bash
cd client-app
npm install
# api/auth.js と api/client.js で API_BASE_URL を環境に合わせて変更
npx expo start
```

### 11.2 本番環境の考慮事項

1. **データベース**: マネージドサービス（AWS RDS, Google Cloud SQL など）
2. **API サーバー**: Node.js ホスティング（AWS EC2, Heroku, Vercel など）
3. **モバイルアプリ**: Expo Application Services (EAS) でビルド・配布
4. **環境変数**: 各環境で適切に設定
5. **CORS 設定**: 本番ドメインのみ許可

---

## 12. まとめ

本設計書は Otium アプリケーションの現状を網羅的に記述したものです。

### 主要な特徴
- **シンプルなアーキテクチャ**: 3層構成で理解しやすい
- **JWT 認証**: モダンでステートレスな認証方式
- **React Native**: クロスプラットフォーム対応
- **REST API**: 標準的で拡張しやすい設計

### 次のステップ
1. 既知のバグ修正（recordsRoutes.js）
2. 記録編集画面の実装
3. テストコードの追加
4. セキュリティ強化
5. 本番環境へのデプロイ準備

---

**文書バージョン**: 1.0  
**最終更新**: 2025年12月7日

